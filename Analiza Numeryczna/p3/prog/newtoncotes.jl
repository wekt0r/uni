#author: Wiktor Garbarek

module DoubleIntegralNewtonCotes
export double_trapezoid, double_simpson, double_n_by_m_order, composite_double_trapezoid, composite_double_simpson

function double_trapezoid(f,a,b,c,d)
    return (b-a)*(d-c)*(f(a,c) + f(a,d) + f(b,c) + f(b,d))/4
end

function double_simpson(f,a,b,c,d)
    ab2 = (a+b)/2
    cd2 = (c+d)/2
    return (b-a)*(d-c)*sum([f(a,d),      4f(ab2, d),    f(b,d),
                          4f(a,cd2),   16f(ab2, cd2), 4f(b,cd2),
                           f(a,c),      4f(ab2, c),    f(b,c)])/36
end

COEFFS = [BigFloat[5.000000000000000000000000000000000000000000000000000000000000000000000000000000e-01, 5.000000000000000000000000000000000000000000000000000000000000000000000000000000e-01],
BigFloat[1.666666666666666666666666666666666666666666666666666666666666666666666666666695e-01, 6.666666666666666666666666666666666666666666666666666666666666666666666666666609e-01, 1.666666666666666666666666666666666666666666666666666666666666666666666666666695e-01],
BigFloat[1.249999999999999930611060960927716223523020744323730468750000000000000000000000e-01, 3.749999999999999791833182882783148670569062232971191406250000000000000000000000e-01, 3.749999999999999791833182882783148670569062232971191406250000000000000000000216e-01, 1.249999999999999930611060960927716223523020744323730468750000000000000000000000e-01],
BigFloat[7.777777777777777777777777777777777777777777777777777777777777777777777777779078e-02, 3.555555555555555555555555555555555555555555555555555555555555555555555555555064e-01, 1.333333333333333333333333333333333333333333333333333333333333333333333333333149e-01, 3.555555555555555555555555555555555555555555555555555555555555555555555555556014e-01, 7.777777777777777777777777777777777777777777777777777777777777777777777777779078e-02], BigFloat[6.597222222222222588441622706214831042517390516069200303819444444444444444422866e-02, 2.604166666666666811226956331400591200993706782658894856770833333333333333339091e-01, 1.736111111111111207484637554267060800662471188439263237847222222222222222218396e-01, 1.736111111111111207484637554267060800662471188439263237847222222222222222218396e-01, 2.604166666666666811226956331400591200993706782658894856770833333333333333336241e-01, 6.597222222222222588441622706214831042517390516069200303819444444444444444451149e-02],
BigFloat[4.880952380952380681433666609336796682327985763549804687500000000000000000023167e-02, 2.571428571428571285828468262479873374104499816894531250000000000000000000017031e-01, 3.214285714285714107285585328099841717630624771118164062499999999999999999175645e-02, 3.238095238095237915487700774974655359983444213867187499999999999999999999958106e-01, 3.214285714285714107285585328099841717630624771118164062500000000000000000170532e-02, 2.571428571428571285828468262479873374104499816894531249999999999999999999997167e-01, 4.880952380952380681433666609336796682327985763549804687500000000000000000006596e-02],
BigFloat[4.346064814814814573559753618781087425304576754570007324218749999999999999947568e-02, 2.070023148148148033238780119091870801639743149280548095703125000000000000008027e-01, 7.656249999999999574992748385682261869078502058982849121093750000000000000000043e-02, 1.729745370370370274350213524172659163014031946659088134765624999999999999923756e-01, 1.729745370370370274350213524172659163014031946659088134765624999999999999803389e-01, 7.656249999999999574992748385682261869078502058982849121093750000000000000000043e-02, 2.07002314814814803323878011909187080163974314928054809570312500000000000005015e-01, 4.346064814814814573559753618781087425304576754570007324218749999999999999994257e-02],
BigFloat[3.48853615520282186948853615520282186948853615520282186948853615520282186931088e-02, 2.07689594356261022927689594356261022927689594356261022927689594356261022896387e-01, -3.27336860670194003527336860670194003527336860670194003527336860670194004348257e-02, 3.702292768959435626102292768959435626102292768959435626102292768959435624635717e-01, -1.601410934744268077601410934744268077601410934744268077601410934744268077952782e-01, 3.702292768959435626102292768959435626102292768959435626102292768959435624006831e-01, -3.273368606701940035273368606701940035273368606701940035273368606701940026817571e-02, 2.076895943562610229276895943562610229276895943562610229276895943562610229251347e-01, 3.488536155202821869488536155202821869488536155202821869488536155202821869760068e-02],
BigFloat[3.188616071428571251567679611937933259468991309404373168945312499999999999272293e-02, 1.756808035714285616763277730889569738792488351464271545410156249999999999918153e-01, 1.205357142857142790232094498037440644111484289169311523437500000000000032745984e-02, 2.15892857142857130872681814537372702034190297126770019531249999999999999421487e-01, 6.448660714285713927741705564500307445996440947055816650390625000000000112154998e-02, 6.448660714285713927741705564500307445996440947055816650390625000000000040523161e-02, 2.158928571428571308726818145373727020341902971267700195312499999999999998035252e-01, 1.205357142857142790232094498037440644111484289169311523437499999999999991813514e-02, 1.756808035714285616763277730889569738792488351464271545410156249999999999611159e-01, 3.188616071428571251567679611937933259468991309404373168945312499999999999613421e-02],
BigFloat[2.683414836192614119351194957615090513154778699822380225347890278445833999181418e-02, 1.775359414248303235744271015089837066959313971439092661694658222436000215986121e-01, -8.104357062690396473611547601809439668316153383262650179560986852653519347182729e-02, 4.549462882796216382095384990691172314578712378363206406826198492865159572298700e-01, -4.351551226551226792786169454201853695166973238555555907850829725829725832175937e-01, 7.137646304312971375856609738258828670106002759604723919502565335898669227805569e-01, -4.35155122655122679278616945420185369516697323855555590785082972582972584527735e-01, 4.549462882796216382095384990691172314578712378363206406826198492865159519893134e-01, -8.10435706269039647361154760180943966831615338326265017956098685265351920681077e-02, 1.775359414248303235744271015089837066959313971439092661694658222436000213241072e-01, 2.68341483619261411935119495761509051315477869982238022534789027844583399893186e-02],
BigFloat[2.493323091196355154447591724757080711110919936538741281633864845127865971271814e-02, 1.548553585207231083545370026779783903334622250416527980219119440310846569349628e-01, -3.716923179379776705164166583805664752591638994194580343875514977402997339965755e-02, 2.896582547949735530131765671979680843060844973291433046734522259424603262291137e-01, -1.10178089175485011876398436971164664228319125151429226789524946263227460721025e-01, 1.779004767416225798936384235001607852989754444924454209665772776124338156669497e-01, 1.77900476741622579893638423500160785298975444492445420966577277612433877048522e-01, -1.101780891754850118763984369711646642283191251514292267895249462632275484089864e-01, 2.896582547949735530131765671979680843060844973291433046734522259424602955383297e-01, -3.716923179379776705164166583805664752591638994194580343875514977402998323133794e-02, 1.548553585207231083545370026779783903334622250416527980219119440310846560846564e-01, 2.493323091196355154447591724757080711110919936538741281633864845127865960313596e-02],
BigFloat[2.163948749663035257197805307569850939088738286173665201985514485514485472280313e-02, 1.570361067503924559609238933042653805606967800266140109890109890109890064193337e-01, -1.20321963750535172427396951838368926751804161262321662712287712287712252944767e-01, 5.664988979274693245937786170205410261016030173439841408591408591408591285361459e-01, -8.165056372199228888834805854730984538218581474029815399444305694305695213897706e-01, 1.387759668902525968347051387242684429223006302779251998001998001998002308783662, -1.392213120213120135836860057921270950586645753233582823426573426573426417258242, 1.387759668902525968347051387242684429223006302779251998001998001998001812014977, -8.165056372199228888834805854730984538218581474029815399444305694305693909879867e-01, 5.664988979274693245937786170205410261016030173439841408591408591408591064575305e-01, -1.203219637505351724273969518383689267518041612623216627122877122877122844067835e-01, 1.570361067503924559609238933042653805606967800266140109890109890109890131934515e-01, 2.163948749663035257197805307569850939088738286173665201985514485514485531240245e-02],
BigFloat[2.033471910512357880529139688744505523194207303872379110562172474749463173058672e-02, 1.398760852657853810236007552885325275417650866155196563241471654021515404116452e-01, -7.771187028841419153758641727889451282056508343514056634869096358819198859205665e-02, 3.878961542438828533783568890132641659476345202978662239280484440622600773762135e-01, -3.769238163321176509908404881759974663447159488576300638603548434439077748187704e-01, 5.136761795561554031225116473730035734763743334621164232110864677770807734980603e-01, -1.071474515504153460457581674784398324416432788509476518598579949568905530610796e-01, -1.07147451550415346045758167478439832441643278850947651859857994956893764384398e-01, 5.136761795561554031225116473730035734763743334621164232110864677770858936499282e-01, -3.769238163321176509908404881759974663447159488576300638603548434439060718442857e-01, 3.878961542438828533783568890132641659476345202978662239280484440622606490890735e-01, -7.77118702884141915375864172788945128205650834351405663486909635881920798719085e-02, 1.398760852657853810236007552885325275417650866155196563241471654021515568076681e-01, 2.033471910512357880529139688744505523194207303872379110562172474749463036941321e-02],
BigFloat[1.803447121579837529108919366132998102077972110118683185394611175861176056610115e-02, 1.420877946927329564504455502033349462405881465515674194873413623413622560138686e-01, -1.54025347052353216642607031900719889189972117933020385489257559570060364140052e-01, 6.997489104402684261159553931567108112550660199805326148099585599585579585661684e-01, -1.323997605646525326115188048038251312621272748205458614623043333980828314201862, 2.524077754435778987022689882571661548730737571424846357707685832685842658769198, -3.357864489505693022997989609595907939325559670112812898838899815462319259808888, 3.903877022839985586240058108625856686597682749845301725184537684537692074391711, -3.357864489505693022997989609595907939325559670112812898838899815462317001944109, 2.524077754435778987022689882571661548730737571424846357707685832685819818340138, -1.323997605646525326115188048038251312621272748205458614623043333980831521024284, 6.997489104402684261159553931567108112550660199805326148099585599585619804807402e-01, -1.540253470523532166426070319007198891899721179330203854892575595700593393252825e-01, 1.420877946927329564504455502033349462405881465515674194873413623413624150506592e-01, 1.803447121579837529108919366132998102077972110118683185394611175861176076457596e-02],
BigFloat[1.708729977162594326380958050435967348992066607665609539825440723420458758490664e-02, 1.285073786774051823182145400177553168228316197933491124833074193785429690229681e-01, -1.12722905059505225351596644159259190724031449032906583502763209472932483861384e-01, 5.070427082102235491690679488008563647964091482860305277034969936853736813253893e-01, -7.562931148441402242695593969167371429739355980282843384620073911074385593910884e-01, 1.191360349506798988033415576619827402170806114750704638350532213801467954269357, -9.680052114962480341535623796155301400108729807563657584799032990267598425731817e-01, 4.930234952338398140513168708414993387811745533431893533840828655074427054987029e-01, 4.930234952338398140513168708414993387811745533431893533840828655075580662257136e-01, -9.680052114962480341535623796155301400108729807563657584799032990266834873870439e-01, 1.191360349506798988033415576619827402170806114750704638350532213801518735067862, -7.562931148441402242695593969167371429739355980282843384620073911074437027031913e-01, 5.07042708210223549169067948800856364796409148286030527703496993685372666601484e-01, -1.127229050595052253515966441592591907240314490329065835027632094729345144886071e-01, 1.285073786774051823182145400177553168228316197933491124833074193785427844831529e-01, 1.708729977162594326380958050435967348992066607665609539825440723420458530879314e-02]]

function NewtonCotesCoeff(a,b,n,k)
    return (b-a)*COEFFS[n][k+1]
end
# generated using function below
# using Polynomials
# function NewtonCotesCoeff(n,k)
#   k = BigInt(k)
#    return 1/n*(-1)^(n-k)/(factorial(k)*factorial(n-k))*polyint(poly([BigInt(j) for j in 0:1:n if j != k]), 0,n)
# end

function double_n_by_m_order(n,m,f,a,b,c,d)
    w_n = [NewtonCotesCoeff(a,b,n,k) for k in 0:1:n]
    w_m = [NewtonCotesCoeff(a,b,m,k) for k in 0:1:m]
    return sum([w_n[i+1]*w_m[j+1]*f(a + i*(b-a)/n, c + j*(d-c)/m) for i in 0:1:n for j in 0:1:m])
end


function _weightsNC2(n,m)
    function _row(n)
        return vcat([1],repmat([2], n-1), [1])
    end
    return hcat(_row(n),
              [2.*_row(n) for i in 1:1:(m-1)]...,
                _row(n))
end

function _weightsNC3(n,m)

    function _row(n)
        return vcat([1,4], repmat([2,4],Int(n/2)-1), [1])
    end
    return hcat(_row(n),
                4*_row(n),
                [hcat(2*_row(n), 4*_row(n)) for i in 1:1:(Int(m/2)-1)]...,
                _row(n))
end

function composite_double_trapezoid(f,a,b,c,d,n,m)
    w = _weightsNC2(n,m)
    return (b-a)*(d-c)*sum([w[i+1,j+1]*f(a + i*(b-a)/n, c + j*(d-c)/n) for i in 0:1:n for j in 0:1:m])/(4m*n)
end

function composite_double_simpson(f,a,b,c,d,n,m)
    assert(n%2 == 0 && m % 2 == 0)
    w = _weightsNC3(n,m)
    return (b-a)*(d-c)*sum([w[i+1,j+1]*f(a + i*(b-a)/n, c + j*(d-c)/n) for i in 0:1:n for j in 0:1:m])/(9m*n)
end

end
